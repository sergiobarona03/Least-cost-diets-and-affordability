cod_mun = city_code,
alimento_sipsa = f,
n_total = n,
n_train = cutoff,
n_test  = n - cutoff,
use_logs = use_logs,
L1 = L1,
L2 = L2,
gamma0 = gamma0,
gamma1 = gamma1,
sigma_eps = sigma_eps
)
}
predictions_by_food <- bind_rows(pred_list)
models_summary <- bind_rows(model_list)
# -----------------------
# Save outputs
# -----------------------
write_csv(
predictions_by_food,
paste0(out_dir, date_tag, "_m3_predictions_by_food_city_", city_code, ".csv")
)
write_csv(
models_summary,
paste0(out_dir, date_tag, "_m3_models_summary_city_", city_code, ".csv")
)
models_summary
View(predictions_by_food)
options(scipen == 9999)
options(scipen = 99999)
options(scipen = 9999)
View(predictions_by_food)
library(tidyverse)
library(readr)
library(ggplot2)
library(ggforce)
# -----------------------
# Settings
# -----------------------
setwd("C:/Users/Portatil/Desktop/Least-cost-diets-and-affordability/Proyecto Interno")
date_tag  <- "121225"
city_code <- "76001"
out_dir <- "working-papers\\working-paper-1225\\m3\\output\\"
in_pred <- paste0(out_dir, date_tag, "_m3_predictions_by_food_city_", city_code, ".csv")
# -----------------------
# Load predictions
# -----------------------
pred <- read_csv(in_pred, show_col_types = FALSE) %>%
mutate(date = as.Date(date))
# -----------------------
# Metrics functions
# -----------------------
rmse <- function(y, yhat) sqrt(mean((y - yhat)^2, na.rm = TRUE))
mape <- function(y, yhat) mean(abs((y - yhat) / y), na.rm = TRUE) * 100
coverage <- function(y, lo, hi) mean(y >= lo & y <= hi, na.rm = TRUE) * 100
# -----------------------
# 1) Metrics BY FOOD
# -----------------------
metrics_by_food <- pred %>%
group_by(alimento_sipsa) %>%
summarise(
n_test = first(n_test),
RMSE = rmse(observed, pred_mean),
MAPE = mape(observed, pred_mean),
COVER_95 = coverage(observed, pred_lo95, pred_hi95),
.groups = "drop"
)
write_csv(metrics_by_food, paste0(out_dir, date_tag, "_m3_metrics_by_food_city_", city_code, ".csv"))
# -----------------------
# 2) Aggregate metrics
# -----------------------
metrics_agg <- tibble(
RMSE = rmse(pred$observed, pred$pred_mean),
MAPE = mape(pred$observed, pred$pred_mean),
COVER_95 = coverage(pred$observed, pred$pred_lo95, pred$pred_hi95)
)
write_csv(metrics_agg, paste0(out_dir, date_tag, "_m3_metrics_aggregate_city_", city_code, ".csv"))
print(metrics_agg)
# -----------------------
# 3) Forecast plots BY FOOD (paginated) with 95% band
# -----------------------
n_per_page <- 9
n_pages <- ceiling(length(unique(pred$alimento_sipsa)) / n_per_page)
for (p in seq_len(n_pages)) {
gg_food <- ggplot(pred, aes(x = date)) +
geom_ribbon(aes(ymin = pred_lo95, ymax = pred_hi95), alpha = 0.25) +
geom_line(aes(y = observed), linewidth = 0.8) +
geom_line(aes(y = pred_mean), linetype = "dashed", linewidth = 0.8) +
facet_wrap_paginate(
~ alimento_sipsa,
scales = "free_y",
ncol = 3, nrow = 3,
page = p
) +
labs(
title = paste0("Observed vs Predicted Retail Prices — Methodology III (ECM) | City ", city_code),
subtitle = paste("95% band | Page", p, "of", n_pages),
y = "Price",
x = NULL
) +
theme_classic()
ggsave(
paste0(out_dir, date_tag, "_m3_forecast_by_food_city_", city_code, "_page_", p, ".png"),
gg_food,
width = 13,
height = 9
)
}
# -----------------------
# Settings
# -----------------------
setwd("C:/Users/Portatil/Desktop/Least-cost-diets-and-affordability/Proyecto Interno")
date_tag  <- "121225"
city_code <- "76001"   # used for M3 and for M1 forecasts if you want city-fixed plots
out_dir_compare <- "working-papers\\working-paper-1225\\compare\\output\\"
# -----------------------
# Helper: locate files
# -----------------------
locate_file <- function(paths) {
for (p in paths) if (file.exists(p)) return(p)
stop("File not found. Tried:\n", paste(paths, collapse = "\n"))
}
# M1 metrics (created earlier)
m1_by_food_path <- locate_file(c(
paste0("output/", date_tag, "_m1_metrics_by_food.csv"),
paste0("working-papers\\working-paper-1225\\m1\\output\\", date_tag, "_m1_metrics_by_food.csv")
))
m1_agg_path <- locate_file(c(
paste0("output/", date_tag, "_m1_metrics_aggregate.csv"),
paste0("working-papers\\working-paper-1225\\m1\\output\\", date_tag, "_m1_metrics_aggregate.csv")
))
# M1 margins (for forecast comparison plots)
m1_margins_path <- locate_file(c(
paste0("output/", date_tag, "_margenes_q1_q3_sipsa.csv"),
paste0("working-papers\\working-paper-1225\\m1\\output\\", date_tag, "_margenes_q1_q3_sipsa.csv")
))
# Base merged dataset (needed only for forecast comparison plots)
data_merged_xlsx <- locate_file(c(
paste0("working-papers\\working-paper-1225\\mapeo ipc-sipsa\\output\\", date_tag, "_dataset_ipc_sipsa.xlsx")
))
# M2
m2_by_food_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m2\\output\\", date_tag, "_m2_metrics_by_food.csv")
))
m2_agg_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m2\\output\\", date_tag, "_m2_metrics_aggregate.csv")
))
m2_pred_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m2\\output\\", date_tag, "_m2_predictions_by_food.csv")
))
# M3
m3_by_food_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m3\\output\\", date_tag, "_m3_metrics_by_food_city_", city_code, ".csv")
))
m3_agg_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m3\\output\\", date_tag, "_m3_metrics_aggregate_city_", city_code, ".csv")
))
m3_pred_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m3\\output\\", date_tag, "_m3_predictions_by_food_city_", city_code, ".csv")
))
# -----------------------
# 1) Load metrics
# -----------------------
m1_by_food_raw <- read_csv(m1_by_food_path, show_col_types = FALSE)
m1_agg_raw     <- read_csv(m1_agg_path, show_col_types = FALSE)
m2_by_food_raw <- read_csv(m2_by_food_path, show_col_types = FALSE)
m2_agg_raw     <- read_csv(m2_agg_path, show_col_types = FALSE)
m3_by_food_raw <- read_csv(m3_by_food_path, show_col_types = FALSE)
m3_agg_raw     <- read_csv(m3_agg_path, show_col_types = FALSE)
# -----------------------
# 2) Harmonize per-food metrics (use Q2 for M1 point forecast)
# -----------------------
m1_by_food <- m1_by_food_raw %>%
transmute(
alimento_sipsa,
n_test,
RMSE = RMSE_Q2,
MAPE = MAPE_Q2
) %>%
mutate(method = "M1 (Margins Q2)")
m2_by_food <- m2_by_food_raw %>%
transmute(
alimento_sipsa,
n_test,
RMSE,
MAPE
) %>%
mutate(method = "M2 (SARIMAX)")
m3_by_food <- m3_by_food_raw %>%
transmute(
alimento_sipsa,
n_test,
RMSE,
MAPE
) %>%
mutate(method = "M3 (ECM)")
# Keep only foods common to all methods (fair comparison)
common_foods <- Reduce(intersect, list(
unique(m1_by_food$alimento_sipsa),
unique(m2_by_food$alimento_sipsa),
unique(m3_by_food$alimento_sipsa)
))
m1_by_food <- m1_by_food %>% filter(alimento_sipsa %in% common_foods)
m2_by_food <- m2_by_food %>% filter(alimento_sipsa %in% common_foods)
m3_by_food <- m3_by_food %>% filter(alimento_sipsa %in% common_foods)
metrics_food_long <- bind_rows(m1_by_food, m2_by_food, m3_by_food)
# Save per-food metrics (common foods only)
write_csv(metrics_food_long, paste0(out_dir_compare, date_tag, "_compare_metrics_by_food_long_common.csv"))
metrics_food_long
View(metrics_food_long)
# Save per-food metrics (common foods only)
write_csv(metrics_food_long, paste0(out_dir_compare, date_tag, "_compare_metrics_by_food_long_common.csv"))
# -----------------------
# 3) Aggregate metrics
#    3.1 Reported aggregates (as you computed in each method)
# -----------------------
m1_agg <- m1_agg_raw %>%
filter(str_detect(tolower(scenario), "q2") | str_detect(tolower(escenario), "q2") |
str_detect(tolower(scenario), "med") | str_detect(tolower(escenario), "med")) %>%
slice(1) %>%
transmute(method = "M1 (Margins Q2)", RMSE = RMSE, MAPE = MAPE)
# If your m1 aggregate file doesn't have "scenario" (depending on your version),
# fall back to taking the second row as Q2.
if (nrow(m1_agg) == 0) {
m1_agg <- m1_agg_raw %>%
slice(2) %>%
transmute(method = "M1 (Margins Q2)", RMSE = RMSE, MAPE = MAPE)
}
m2_agg <- m2_agg_raw %>%
transmute(method = "M2 (SARIMAX)", RMSE = RMSE, MAPE = MAPE)
m3_agg <- m3_agg_raw %>%
transmute(method = "M3 (ECM)", RMSE = RMSE, MAPE = MAPE)
agg_reported <- bind_rows(m1_agg, m2_agg, m3_agg)
# -----------------------
# 3) Aggregate metrics
#    3.1 Reported aggregates (as you computed in each method)
# -----------------------
m1_agg <- m1_agg_raw %>%
filter(str_detect(tolower(scenario), "q2") | str_detect(tolower(escenario), "q2") |
str_detect(tolower(scenario), "med") | str_detect(tolower(escenario), "med")) %>%
slice(1) %>%
transmute(method = "M1 (Margins Q2)", RMSE = RMSE, MAPE = MAPE)
# -----------------------
# 4) “Winner” method counts by food (RMSE & MAPE)
# -----------------------
wins_rmse <- metrics_food_long %>%
group_by(alimento_sipsa) %>%
slice_min(order_by = RMSE, n = 1, with_ties = TRUE) %>%
ungroup() %>%
count(method, name = "wins_rmse") %>%
mutate(share_rmse = wins_rmse / length(common_foods) * 100)
wins_rmse
wins_mape <- metrics_food_long %>%
group_by(alimento_sipsa) %>%
slice_min(order_by = MAPE, n = 1, with_ties = TRUE) %>%
ungroup() %>%
count(method, name = "wins_mape") %>%
mutate(share_mape = wins_mape / length(common_foods) * 100)
wins_mape
wins_summary <- full_join(wins_rmse, wins_mape, by = "method") %>%
replace_na(list(wins_rmse = 0, share_rmse = 0, wins_mape = 0, share_mape = 0)) %>%
arrange(desc(wins_rmse), desc(wins_mape))
wins_summary
# -----------------------
# 5) Ranking / decision table (combine RMSE + MAPE on weighted aggregates)
# -----------------------
decision_table <- agg_common_weighted %>%
mutate(
rank_RMSE = rank(RMSE_weighted, ties.method = "min"),
rank_MAPE = rank(MAPE_weighted, ties.method = "min"),
score = rank_RMSE + rank_MAPE
) %>%
arrange(score, RMSE_weighted, MAPE_weighted)
decision_table
# 6.1 Aggregate bar charts (common-food weighted)
agg_long <- agg_common_weighted %>%
select(method, RMSE_weighted, MAPE_weighted) %>%
pivot_longer(cols = c(RMSE_weighted, MAPE_weighted),
names_to = "metric", values_to = "value")
p_agg <- ggplot(agg_long, aes(x = reorder(method, value), y = value)) +
geom_col() +
facet_wrap(~ metric, scales = "free_y") +
coord_flip() +
labs(
title = "Aggregate performance (common foods, weighted)",
x = NULL,
y = NULL
) +
theme_classic()
# 6.2 Boxplots of per-food metrics (common foods)
p_box_rmse <- ggplot(metrics_food_long, aes(x = method, y = RMSE)) +
geom_boxplot() +
coord_flip() +
labs(
title = "Distribution of RMSE across foods (common foods)",
x = NULL, y = "RMSE"
) +
theme_classic()
p_box_rmse
p_box_mape <- ggplot(metrics_food_long, aes(x = method, y = MAPE)) +
geom_boxplot() +
coord_flip() +
labs(
title = "Distribution of MAPE across foods (common foods)",
x = NULL, y = "MAPE (%)"
) +
theme_classic()
p_box_mape
############################################################
## Compare M1 vs M2 vs M3 metrics + tables + figures       ##
############################################################
# -----------------------
# Libraries
# -----------------------
library(tidyverse)
library(lubridate)
library(readxl)
library(readr)
library(ggplot2)
library(ggforce)
# -----------------------
# Settings
# -----------------------
setwd("C:/Users/Portatil/Desktop/Least-cost-diets-and-affordability/Proyecto Interno")
date_tag  <- "121225"
city_code <- "76001"
out_dir_compare <- "working-papers\\working-paper-1225\\compare\\output\\"
# -----------------------
# Helper: locate files
# -----------------------
locate_file <- function(paths) {
for (p in paths) if (file.exists(p)) return(p)
stop("File not found. Tried:\n", paste(paths, collapse = "\n"))
}
# -----------------------
# 0) File paths (robust)
# -----------------------
# M1 metrics (created earlier)
m1_by_food_path <- locate_file(c(
paste0("output/", date_tag, "_m1_metrics_by_food.csv"),
paste0("working-papers\\working-paper-1225\\m1\\output\\", date_tag, "_m1_metrics_by_food.csv")
))
m1_agg_path <- locate_file(c(
paste0("output/", date_tag, "_m1_metrics_aggregate.csv"),
paste0("working-papers\\working-paper-1225\\m1\\output\\", date_tag, "_m1_metrics_aggregate.csv")
))
# M2
m2_by_food_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m2\\output\\", date_tag, "_m2_metrics_by_food.csv")
))
m2_agg_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m2\\output\\", date_tag, "_m2_metrics_aggregate.csv")
))
# M3
m3_by_food_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m3\\output\\", date_tag, "_m3_metrics_by_food_city_", city_code, ".csv")
))
m3_agg_path <- locate_file(c(
paste0("working-papers\\working-paper-1225\\m3\\output\\", date_tag, "_m3_metrics_aggregate_city_", city_code, ".csv")
))
# -----------------------
# 1) Load metrics
# -----------------------
m1_by_food_raw <- read_csv(m1_by_food_path, show_col_types = FALSE)
m1_agg_raw     <- read_csv(m1_agg_path, show_col_types = FALSE)
m2_by_food_raw <- read_csv(m2_by_food_path, show_col_types = FALSE)
m2_agg_raw     <- read_csv(m2_agg_path, show_col_types = FALSE)
m3_by_food_raw <- read_csv(m3_by_food_path, show_col_types = FALSE)
m3_agg_raw     <- read_csv(m3_agg_path, show_col_types = FALSE)
# -----------------------
# 2) Harmonize per-food metrics (use Q2 for M1 point forecast)
# -----------------------
m1_by_food <- m1_by_food_raw %>%
transmute(
alimento_sipsa,
n_test,
RMSE = RMSE_Q2,
MAPE = MAPE_Q2
) %>%
mutate(method = "M1 (Margins Q2)")
m2_by_food <- m2_by_food_raw %>%
transmute(
alimento_sipsa,
n_test,
RMSE,
MAPE
) %>%
mutate(method = "M2 (SARIMAX)")
m3_by_food <- m3_by_food_raw %>%
transmute(
alimento_sipsa,
n_test,
RMSE,
MAPE
) %>%
mutate(method = "M3 (ECM)")
# Keep only foods common to all methods (fair comparison)
common_foods <- Reduce(intersect, list(
unique(m1_by_food$alimento_sipsa),
unique(m2_by_food$alimento_sipsa),
unique(m3_by_food$alimento_sipsa)
))
m1_by_food <- m1_by_food %>% filter(alimento_sipsa %in% common_foods)
m2_by_food <- m2_by_food %>% filter(alimento_sipsa %in% common_foods)
m3_by_food <- m3_by_food %>% filter(alimento_sipsa %in% common_foods)
metrics_food_long <- bind_rows(m1_by_food, m2_by_food, m3_by_food)
# Save per-food metrics (common foods only)
write_csv(metrics_food_long, paste0(out_dir_compare, date_tag, "_compare_metrics_by_food_long_common.csv"))
# -----------------------
# 3) Simple summary table (across foods)
# -----------------------
summary_methods <- metrics_food_long %>%
group_by(method) %>%
summarise(
n_foods = n_distinct(alimento_sipsa),
RMSE_mean = mean(RMSE, na.rm = TRUE),
RMSE_median = median(RMSE, na.rm = TRUE),
MAPE_mean = mean(MAPE, na.rm = TRUE),
MAPE_median = median(MAPE, na.rm = TRUE),
.groups = "drop"
)
write_csv(summary_methods,
paste0(out_dir_compare, date_tag, "_compare_summary_methods_common.csv"))
# -----------------------
# 4) “Winner” method counts by food (RMSE & MAPE) - tie-safe
# -----------------------
# RMSE winners (ties split equally)
wins_rmse <- metrics_food_long %>%
group_by(alimento_sipsa) %>%
filter(RMSE == min(RMSE, na.rm = TRUE)) %>%
mutate(weight = 1 / n()) %>%
ungroup() %>%
group_by(method) %>%
summarise(
wins_rmse = sum(weight),
share_rmse = wins_rmse / length(common_foods) * 100,
.groups = "drop"
)
# MAPE winners (ties split equally)
wins_mape <- metrics_food_long %>%
group_by(alimento_sipsa) %>%
filter(MAPE == min(MAPE, na.rm = TRUE)) %>%
mutate(weight = 1 / n()) %>%
ungroup() %>%
group_by(method) %>%
summarise(
wins_mape = sum(weight),
share_mape = wins_mape / length(common_foods) * 100,
.groups = "drop"
)
wins_summary <- full_join(wins_rmse, wins_mape, by = "method") %>%
replace_na(list(wins_rmse = 0, share_rmse = 0, wins_mape = 0, share_mape = 0)) %>%
arrange(desc(wins_rmse), desc(wins_mape))
write_csv(wins_summary, paste0(out_dir_compare, date_tag, "_compare_wins_summary_common.csv"))
# -----------------------
# 5) Figures
# -----------------------
# 5.1 Winner shares plot
wins_plot <- wins_summary %>%
select(method, share_rmse, share_mape) %>%
pivot_longer(cols = c(share_rmse, share_mape),
names_to = "metric", values_to = "share") %>%
mutate(metric = recode(metric,
share_rmse = "Winner share (RMSE)",
share_mape = "Winner share (MAPE)"))
p_wins <- ggplot(wins_plot, aes(x = method, y = share)) +
geom_col() +
facet_wrap(~ metric) +
coord_flip() +
labs(
title = "Share of foods where each methodology is best (common foods)",
x = NULL,
y = "% of foods"
) +
theme_classic()
ggsave(
paste0(out_dir_compare, date_tag, "_fig_winner_shares_common.png"),
p_wins, width = 10, height = 5
)
# 5.2 Boxplot RMSE
p_box_rmse <- ggplot(metrics_food_long, aes(x = method, y = RMSE)) +
geom_boxplot() +
coord_flip() +
labs(
title = "RMSE distribution across foods (common foods)",
x = NULL, y = "RMSE"
) +
theme_classic()
ggsave(
paste0(out_dir_compare, date_tag, "_fig_box_rmse_common.png"),
p_box_rmse, width = 10, height = 5
)
# 5.3 Boxplot MAPE
p_box_mape <- ggplot(metrics_food_long, aes(x = method, y = MAPE)) +
geom_boxplot() +
coord_flip() +
labs(
title = "MAPE distribution across foods (common foods)",
x = NULL, y = "MAPE (%)"
) +
theme_classic()
ggsave(
paste0(out_dir_compare, date_tag, "_fig_box_mape_common.png"),
p_box_mape, width = 10, height = 5
)
# -----------------------
# Console summary
# -----------------------
cat("\n=== COMMON FOODS COUNT ===\n")
cat(length(common_foods), "\n")
cat("\nSaved outputs in:\n", out_dir_compare, "\n")
common_foods
